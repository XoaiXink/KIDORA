@using KIDORA.Data
@model IEnumerable<DonHang>

@{
    ViewData["Title"] = "Quản lý đơn hàng";

    string keyword = ViewBag.Keyword as string;
    string trangThaiDon = ViewBag.TrangThaiDon as string;
    DateTime? fromDate = ViewBag.FromDate as DateTime?;
    DateTime? toDate = ViewBag.ToDate as DateTime?;
    var allStatus = ViewBag.AllStatus as List<string>;
    int soTrang = ViewBag.SoTrang ?? 1;
    int trangHienTai = ViewBag.TrangHienTai ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int tongDon = ViewBag.TongDon ?? 0;
}

<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2 text-dark mb-0">Quản lý đơn hàng</h1>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold mb-1 small">Từ khóa</label>
                    <input type="text"
                           name="keyword"
                           value="@keyword"
                           class="form-control"
                           placeholder="Mã đơn / Số đơn / Tên / SĐT" />
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold mb-1 small">Trạng thái đơn</label>
                    <select name="trangThaiDon" class="form-select">
                        <option value="">-- Tất cả --</option>
                        @if (allStatus != null)
                        {
                            foreach (var st in allStatus)
                            {
                                var value = st?.Trim();
                                <option value="@value"
                                        selected="@(trangThaiDon != null && trangThaiDon.Trim() == value)">
                                    @value
                                </option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold mb-1 small">Từ ngày</label>
                    <input type="date"
                           name="fromDate"
                           value="@(fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "")"
                           class="form-control" />
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold mb-1 small">Đến ngày</label>
                    <input type="date"
                           name="toDate"
                           value="@(toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "")"
                           class="form-control" />
                </div>

                <div class="col-md-12 col-lg-auto d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Xóa lọc
                    </a>
                </div>
            </form>

            @if (!string.IsNullOrWhiteSpace(keyword) || !string.IsNullOrWhiteSpace(trangThaiDon) || fromDate.HasValue || toDate.HasValue)
            {
                <div class="mt-3 text-muted small d-flex flex-wrap align-items-center gap-2">
                    <span class="fw-semibold text-dark">Bộ lọc:</span>
                    @if (!string.IsNullOrWhiteSpace(keyword))
                    {
                        <span class="badge bg-light text-dark border">Từ khóa: "@keyword"</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(trangThaiDon))
                    {
                        <span class="badge bg-light text-dark border">Trạng thái: @trangThaiDon</span>
                    }
                    @if (fromDate.HasValue)
                    {
                        <span class="badge bg-light text-dark border">Từ ngày: @fromDate.Value.ToString("dd/MM/yyyy")</span>
                    }
                    @if (toDate.HasValue)
                    {
                        <span class="badge bg-light text-dark border">Đến ngày: @toDate.Value.ToString("dd/MM/yyyy")</span>
                    }
                </div>
            }
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Mã đơn</th>
                            <th>Số đơn</th>
                            <th>Ngày đặt</th>
                            <th>Người nhận</th>
                            <th>SĐT</th>
                            <th class="text-end">Tổng thanh toán</th>
                            <th>Trạng thái đơn</th>
                            <th>TT thanh toán</th>
                            <th class="text-center" style="width: 140px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark">
                        @if (Model != null && Model.Any())
                        {
                            foreach (var d in Model)
                            {
                                <tr>
                                    <td class="fw-semibold">@d.MaDonHang</td>
                                    <td>@d.SoDonHang</td>
                                    <td>@d.NgayDat.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@d.TenNguoiNhan</td>
                                    <td>@d.SdtnguoiNhan</td>
                                    <td class="text-end">@String.Format("{0:N0} đ", d.TongThanhToan)</td>
                                    <td>
                                        <span class="badge bg-light text-dark border">@d.TrangThaiDon</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">@d.TrangThaiThanhToan</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a class="btn btn-outline-info"
                                               asp-area="Admin"
                                               asp-controller="AdminDonHangs"
                                               asp-action="Details"
                                               asp-route-id="@d.MaDonHang.Trim()">
                                                <i class="fas fa-info-circle"></i> Chi tiết
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="text-center py-4 text-muted">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <div>Không tìm thấy đơn hàng nào.</div>
                                    @if (!string.IsNullOrEmpty(keyword))
                                    {
                                        <small>Thử tìm với từ khóa khác</small>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (soTrang > 1)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted small">
                Hiển thị <strong>@((trangHienTai - 1) * pageSize + 1)</strong> -
                <strong>@(Math.Min(trangHienTai * pageSize, tongDon))</strong>
                trong tổng <strong>@tongDon</strong> đơn
            </div>
            <nav aria-label="Phân trang đơn hàng">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(trangHienTai == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = 1 })">&laquo;&laquo;</a>
                    </li>
                    <li class="page-item @(trangHienTai == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = trangHienTai - 1 })">&laquo;</a>
                    </li>

                    @{
                        int startPage = Math.Max(1, trangHienTai - 2);
                        int endPage = Math.Min(soTrang, trangHienTai + 2);
                    }

                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = 1 })">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == trangHienTai ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = i })">@i</a>
                        </li>
                    }

                    @if (endPage < soTrang)
                    {
                        if (endPage < soTrang - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = soTrang })">@soTrang</a>
                        </li>
                    }

                    <li class="page-item @(trangHienTai == soTrang ? "disabled" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = trangHienTai + 1 })">&raquo;</a>
                    </li>
                    <li class="page-item @(trangHienTai == soTrang ? "disabled" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { keyword, trangThaiDon, fromDate = fromDate?.ToString("yyyy-MM-dd"), toDate = toDate?.ToString("yyyy-MM-dd"), page = soTrang })">&raquo;&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    }
    else if (tongDon > 0)
    {
        <div class="text-muted small mt-3">
            Hiển thị tất cả <strong>@tongDon</strong> đơn
        </div>
    }
</div>
