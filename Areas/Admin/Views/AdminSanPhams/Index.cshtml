@model IEnumerable<KIDORA.Data.SanPham>

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    int trangHienTai = ViewBag.TrangHienTai ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int rowNumber = (trangHienTai - 1) * pageSize + 1;
    string keyword = ViewBag.Keyword ?? "";
}

<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2 text-dark">Danh sách Sản Phẩm</h1>
        <a asp-action="Create" class="btn btn-success">
            <i class="fas fa-plus"></i> Thêm sản phẩm mới
        </a>
    </div>

    <!-- Form tìm kiếm -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <!-- Thay thế phần form tìm kiếm hiện tại -->
            <form asp-action="Index" method="get" class="mb-4">
                <div class="row g-2">
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" name="keyword" class="form-control"
                                   placeholder="Tìm kiếm sản phẩm..." value="@ViewBag.Keyword">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i> Tìm kiếm
                            </button>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(keyword))
                    {
                        <div class="col-md-4">
                            <a asp-action="Index" class="btn btn-outline-secondary">Xóa bộ lọc</a>
                        </div>
                    }
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle text-dark">

                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#</th>
                            <th>Hình ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>SKU</th>
                            <th>Danh mục</th>
                            <th>Nhà cung cấp</th>
                            <th class="text-end">Giá bán</th>
                            <th class="text-end">Giá niêm yết</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Hành động</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="text-center">@(rowNumber++)</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.AnhChinh))
                                        {
                                            <img src="~/customerassets/img/Anh/@item.AnhChinh" alt="@item.TenSp" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;" />
                                        }
                                        else
                                        {
                                            <span class="text-muted">Chưa có ảnh</span>
                                        }
                                    </td>
                                    <td class="fw-bold">@Html.DisplayFor(modelItem => item.TenSp)</td>
                                    <td>@Html.DisplayFor(modelItem => item.Sku)</td>
                                    <td>@Html.DisplayFor(modelItem => item.MaDanhMucNavigation.TenDanhMuc)</td>
                                    <td>@Html.DisplayFor(modelItem => item.MaNccNavigation.TenNcc)</td>
                                    <td class="text-end">@item.DonGiaBan.ToString("N0") đ</td>
                                    <td class="text-end">@item.GiaNiemYet.ToString("N0") đ</td>
                                    <td class="text-center">
                                        @{
                                            var badgeClass = item.DangBan ? "bg-success" : "bg-danger";
                                            var badgeText = item.DangBan ? "Đang bán" : "Ngừng bán";
                                        }
                                        <span class="badge @badgeClass p-2">@badgeText</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-action="Edit" asp-controller="AdminSanPhams" asp-area="Admin" asp-route-id="@item.MaSp"
                                               class="btn btn-outline-primary"
                                               title="Sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a asp-action="Details" asp-controller="AdminSanPhams" asp-area="Admin" asp-route-id="@item.MaSp"
                                               class="btn btn-outline-info"
                                               title="Chi tiết">
                                                <i class="fas fa-info-circle"></i>
                                            </a>

                                            <form asp-action="ToggleVisibilityPost"
                                                  asp-controller="AdminSanPhams"
                                                  asp-area="Admin"
                                                  method="post"
                                                  class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.MaSp" />
                                                <button type="submit"
                                                        class="btn @(item.DangBan ? "btn-outline-warning" : "btn-outline-success")"
                                                        title="@(item.DangBan ? "Vô hiệu hóa / Ẩn" : "Kích hoạt / Hiển thị")">
                                                    <i class="fas @(item.DangBan ? "fa-eye-slash" : "fa-eye")"></i>
                                                </button>
                                            </form>

                                            <a asp-action="Delete" asp-controller="AdminSanPhams" asp-area="Admin" asp-route-id="@item.MaSp"
                                               class="btn btn-outline-danger"
                                               title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <p class="mb-0">Không tìm thấy sản phẩm nào</p>
                                        @if (!string.IsNullOrEmpty(keyword))
                                        {
                                            <small>Thử tìm kiếm với từ khóa khác</small>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Phân trang -->
    @{
        int soTrang = ViewBag.SoTrang ?? 1;
        int tongSanPham = ViewBag.TongSanPham ?? 0;
    }

    @if (soTrang > 1)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Hiển thị <strong>@((trangHienTai - 1) * pageSize + 1)</strong> -
                <strong>@(Math.Min(trangHienTai * pageSize, tongSanPham))</strong>
                trong tổng số <strong>@tongSanPham</strong> sản phẩm
            </div>
            <nav aria-label="Phân trang">
                <ul class="pagination pagination-sm mb-0">
                    <!-- Nút Trang đầu -->
                    <li class="page-item @(trangHienTai == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="?keyword=@keyword&page=1"
                           aria-label="Trang đầu">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>

                    <!-- Nút Trang trước -->
                    <li class="page-item @(trangHienTai == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="?keyword=@keyword&page=@(trangHienTai - 1)"
                           aria-label="Trang trước">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    <!-- Các số trang -->
                    @{
                        int startPage = Math.Max(1, trangHienTai - 2);
                        int endPage = Math.Min(soTrang, trangHienTai + 2);
                    }

                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?keyword=@keyword&page=1">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == trangHienTai ? "active" : "")">
                            <a class="page-link" href="?keyword=@keyword&page=@i">@i</a>
                        </li>
                    }

                    @if (endPage < soTrang)
                    {
                        @if (endPage < soTrang - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="?keyword=@keyword&page=@soTrang">@soTrang</a>
                        </li>
                    }

                    <!-- Nút Trang sau -->
                    <li class="page-item @(trangHienTai == soTrang ? "disabled" : "")">
                        <a class="page-link"
                           href="?keyword=@keyword&page=@(trangHienTai + 1)"
                           aria-label="Trang sau">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>

                    <!-- Nút Trang cuối -->
                    <li class="page-item @(trangHienTai == soTrang ? "disabled" : "")">
                        <a class="page-link"
                           href="?keyword=@keyword&page=@soTrang"
                           aria-label="Trang cuối">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
    else if (tongSanPham > 0)
    {
        <div class="text-muted mt-3">
            Hiển thị tất cả <strong>@tongSanPham</strong> sản phẩm
        </div>
    }
</div>

