@using System.Text.Json
@model KIDORA.ViewModels.ThanhToanVM
@{
    ViewData["Title"] = "Thanh Toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var tongTien = Model.GioHang.Sum(p => p.ThanhTien);
    var phiVanChuyen = 30000m;
    var tongCong = tongTien + phiVanChuyen;
    var giamGia = Model.SoTienGiam;
    var tongSauGiam = Math.Max(0, tongCong - giamGia);
}

<!-- Single Page Header start -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Thanh Toán</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-controller="GioHang" asp-action="Index">Giỏ hàng</a></li>
        <li class="breadcrumb-item active text-white">Thanh toán</li>
    </ol>
</div>
<!-- Single Page Header End -->
<!-- Checkout Page Start -->
<div class="container-fluid py-5">
    <div class="container py-5">

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fa fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fa fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div asp-validation-summary="All" class="text-danger mb-3"></div>

        <div class="row g-5">
            <!-- THÔNG TIN GIAO HÀNG -->
            <div class="col-md-12 col-lg-6 col-xl-7">
                <form id="mainForm" asp-action="ThanhToan" asp-controller="GioHang" method="post">
                    <input type="hidden" asp-for="MaGiamGia" />
                    <input type="hidden" asp-for="SoTienGiam" />

                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <h4 class="mb-4 border-bottom pb-2">
                                <i class="fa fa-truck me-2 text-primary"></i>
                                Thông tin giao hàng
                            </h4>

                            @if (Model.DiaChiDaLuu?.Any() == true)
                            {
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">Chọn địa chỉ đã lưu</label>
                                    <div class="list-group">
                                        @foreach (var diaChi in Model.DiaChiDaLuu)
                                        {
                                            <label class="list-group-item list-group-item-action d-flex gap-3 align-items-start">
                                                <input class="form-check-input mt-1" type="checkbox" name="savedAddress"
                                                       value="@diaChi.MaDiaChi"
                                                       data-ten="@diaChi.TenNguoiNhan"
                                                       data-phone="@diaChi.DienThoaiNhan"
                                                       data-diachi="@diaChi.DiaChiChiTiet"
                                                       data-phuong="@diaChi.PhuongXa"
                                                       data-quan="@diaChi.QuanHuyen"
                                                       data-tinh="@diaChi.TinhThanh"
                                                       @((diaChi.MacDinh) ? "checked=\"checked\"" : "") />
                                                <div>
                                                    <div class="fw-semibold">@diaChi.TenNguoiNhan</div>
                                                    <div class="text-muted small">@diaChi.DienThoaiNhan</div>
                                                    <div class="small">@diaChi.DiaChiChiTiet, @diaChi.PhuongXa, @diaChi.QuanHuyen, @diaChi.TinhThanh</div>
                                                    @if (diaChi.MacDinh)
                                                    {
                                                        <span class="badge bg-primary-subtle text-primary border border-primary mt-1">Mặc định</span>
                                                    }
                                                </div>
                                            </label>
                                        }
                                    </div>
                                </div>
                            }

                            <div class="mb-3">
                                <label class="form-label">
                                    Họ tên người nhận <sup class="text-danger">*</sup>
                                </label>
                                <input asp-for="HoTen" class="form-control"
                                       placeholder="Nhập họ tên người nhận hàng" required>
                                <span asp-validation-for="HoTen" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    Số điện thoại <sup class="text-danger">*</sup>
                                </label>
                                <input asp-for="DienThoai" type="tel" class="form-control"
                                       placeholder="Nhập số điện thoại liên hệ"
                                       pattern="[0-9]{10,11}" required>
                                <span asp-validation-for="DienThoai" class="text-danger"></span>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Tỉnh / Thành phố <sup class="text-danger">*</sup>
                                    </label>
                                    <select id="tinh" asp-for="TinhThanh" class="form-select" required>
                                        <option value="">-- Chọn tỉnh/thành phố --</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Quận / Huyện <sup class="text-danger">*</sup>
                                    </label>
                                    <select id="quan" asp-for="QuanHuyen" class="form-select" required disabled>
                                        <option value="">-- Chọn quận/huyện --</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Phường / Xã <sup class="text-danger">*</sup>
                                    </label>
                                    <select id="phuong" asp-for="PhuongXa" class="form-select" required disabled>
                                        <option value="">-- Chọn phường/xã --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    Địa chỉ cụ thể <sup class="text-danger">*</sup>
                                </label>
                                <input asp-for="DiaChi" class="form-control"
                                       placeholder="Số nhà, tên đường" required>
                                <span asp-validation-for="DiaChi" class="text-danger"></span>
                            </div>
                            <div class="mb-0">
                                <label class="form-label">Ghi chú đơn hàng (Không bắt buộc)</label>
                                <textarea asp-for="GhiChu" class="form-control" rows="3"
                                          placeholder="Ví dụ: giao giờ hành chính, gọi trước khi giao"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tóm tắt đơn hàng -->
            <div class="col-md-12 col-lg-6 col-xl-5">
                <h4 class="mb-4">Đơn hàng của bạn</h4>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Sản phẩm</th>
                                <th scope="col">Tên</th>
                                <th scope="col">SL</th>
                                <th scope="col">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.GioHang)
                            {
                                <tr>
                                    <td>
                                        <img src="~/customerassets/img/Anh/@item.AnhChinh" class="img-fluid rounded"
                                             style="width: 60px; height: 60px; object-fit: cover;" alt="@item.TenSp">
                                    </td>
                                    <td class="align-middle">@item.TenSp</td>
                                    <td class="align-middle">@item.SoLuong</td>
                                    <td class="align-middle">@item.ThanhTien.ToString("N0")đ</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- ✅ Form riêng cho mã giảm giá -->
                <form asp-action="ApDungMaGiamGia" asp-controller="GioHang" method="post" class="card mb-3">
                    <!-- ✅ Preserve form data -->
                    <input type="hidden" name="HoTen" value="@Model.HoTen" />
                    <input type="hidden" name="DienThoai" value="@Model.DienThoai" />
                    <input type="hidden" name="DiaChi" value="@Model.DiaChi" />
                    <input type="hidden" name="TinhThanh" value="@Model.TinhThanh" />
                    <input type="hidden" name="QuanHuyen" value="@Model.QuanHuyen" />
                    <input type="hidden" name="PhuongXa" value="@Model.PhuongXa" />
                    <input type="hidden" name="GhiChu" value="@Model.GhiChu" />

                    <div class="card-body">
                        <label asp-for="MaGiamGia" class="form-label fw-semibold">Nhập mã giảm giá</label>
                        <div class="input-group">
                            <input asp-for="MaGiamGia" class="form-control" placeholder="Ví dụ: SALE10" />
                            <button type="submit" class="btn btn-outline-primary">Áp dụng</button>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.MaGiamGia) && Model.SoTienGiam > 0)
                        {
                            <div class="alert alert-success mt-2 mb-0">
                                <i class="fa fa-check-circle me-1"></i>
                                Đã áp dụng mã <strong>@Model.MaGiamGia</strong>
                            </div>
                        }
                    </div>
                </form>

                <!-- Tổng tiền -->
                <div class="bg-light rounded p-4">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Tạm tính:</span>
                        <span>@tongTien.ToString("N0")đ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Phí vận chuyển:</span>
                        <span>@phiVanChuyen.ToString("N0")đ</span>
                    </div>
                    <hr>
                    @if (giamGia > 0)
                    {
                        <div class="d-flex justify-content-between mb-3">
                            <span>Giảm giá:</span>
                            <span class="text-success fw-bold">-@giamGia.ToString("N0")đ</span>
                        </div>
                    }
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Tổng cộng:</strong>
                        <strong class="text-primary fs-5">@tongSauGiam.ToString("N0")đ</strong>
                    </div>
                </div>

                <!-- ✅ Nút đặt hàng -->
                <div class="mt-3">
                    <button type="button" onclick="submitMainForm('COD')" class="btn btn-primary w-100 py-3">
                        <i class="fa fa-shopping-cart me-2"></i>Đặt hàng (COD)
                    </button>
                </div>
                <div class="mt-2">
                    <button type="button" onclick="submitMainForm('Thanh toán VNPay')" class="btn btn-success w-100 py-3">
                        <i class="fa fa-credit-card me-2"></i>Thanh toán VNPay
                    </button>
                </div>

                <div class="text-center mt-3">
                    <a asp-controller="GioHang" asp-action="Index" class="text-muted">
                        <i class="fa fa-arrow-left me-2"></i> Quay lại giỏ hàng
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Checkout Page End -->

<script>
    // ✅ Submit form chính với payment method
    function submitMainForm(paymentMethod) {
        const form = document.getElementById('mainForm');
        const paymentInput = document.createElement('input');
        paymentInput.type = 'hidden';
        paymentInput.name = 'payment';
        paymentInput.value = paymentMethod;
        form.appendChild(paymentInput);
        form.submit();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const tinhSelect = document.getElementById("tinh");
        const quanSelect = document.getElementById("quan");
        const phuongSelect = document.getElementById("phuong");

        const hoTenInput = document.querySelector('[name="HoTen"]');
        const phoneInput = document.querySelector('[name="DienThoai"]');
        const diaChiInput = document.querySelector('[name="DiaChi"]');

        const savedAddressCheckboxes = document.querySelectorAll('input[name="savedAddress"]');

        let pendingAddress = null;

        function resetQuanHuyen() {
            quanSelect.innerHTML = '<option value="">-- Chọn quận/huyện --</option>';
            quanSelect.disabled = true;
        }

        function resetPhuongXa() {
            phuongSelect.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
            phuongSelect.disabled = true;
        }

        function clearAutoFill() {
            hoTenInput.value = "";
            phoneInput.value = "";
            diaChiInput.value = "";
            tinhSelect.value = "";
            resetQuanHuyen();
            resetPhuongXa();
        }

        function loadQuanHuyen(tinhCode, preQuan, prePhuong) {
            resetQuanHuyen();
            resetPhuongXa();
            if (!tinhCode) return;

            fetch(`https://provinces.open-api.vn/api/p/${tinhCode}?depth=2`)
                .then(res => res.json())
                .then(data => {
                    quanSelect.disabled = false;
                    data.districts.forEach(q => {
                        quanSelect.innerHTML += `
                            <option value="${q.name}" data-code="${q.code}">
                                ${q.name}
                            </option>`;
                    });

                    if (preQuan) {
                        quanSelect.value = preQuan;
                        const code = quanSelect.selectedOptions[0]?.dataset.code;
                        loadPhuong(code, prePhuong);
                    }
                });
        }

        function loadPhuong(quanCode, prePhuong) {
            resetPhuongXa();
            if (!quanCode) return;

            fetch(`https://provinces.open-api.vn/api/d/${quanCode}?depth=2`)
                .then(res => res.json())
                .then(data => {
                    phuongSelect.disabled = false;
                    data.wards.forEach(p => {
                        phuongSelect.innerHTML += `
                            <option value="${p.name}">${p.name}</option>`;
                    });

                    if (prePhuong) {
                        phuongSelect.value = prePhuong;
                    }
                });
        }

        function tryApplyPendingAddress() {
            if (!pendingAddress) return;
            if (tinhSelect.options.length <= 1) return;

            const { ten, phone, diachi, tinh, quan, phuong } = pendingAddress;

            hoTenInput.value = ten || "";
            phoneInput.value = phone || "";
            diaChiInput.value = diachi || "";

            const matchedTinh = Array.from(tinhSelect.options)
                .find(o => o.value === tinh);

            if (matchedTinh) {
                tinhSelect.value = tinh;
                loadQuanHuyen(matchedTinh.dataset.code, quan, phuong);
                pendingAddress = null;
            }
        }

        fetch("https://provinces.open-api.vn/api/p/")
            .then(res => res.json())
            .then(data => {
                data.forEach(tinh => {
                    tinhSelect.innerHTML += `
                        <option value="${tinh.name}" data-code="${tinh.code}">
                            ${tinh.name}
                        </option>`;
                });

                tryApplyPendingAddress();
            });

        savedAddressCheckboxes.forEach(cb => {
            cb.addEventListener("change", function () {
                savedAddressCheckboxes.forEach(x => {
                    if (x !== this) x.checked = false;
                });

                if (this.checked) {
                    pendingAddress = this.dataset;
                    tryApplyPendingAddress();
                } else {
                    pendingAddress = null;
                    clearAutoFill();
                }
            });
        });

        tinhSelect.addEventListener("change", function () {
            const code = this.selectedOptions[0]?.dataset.code;
            loadQuanHuyen(code);
        });

        quanSelect.addEventListener("change", function () {
            const code = this.selectedOptions[0]?.dataset.code;
            loadPhuong(code);
        });
    });
</script>