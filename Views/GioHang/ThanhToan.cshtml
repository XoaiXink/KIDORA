@using System.Text.Json
@model KIDORA.ViewModels.ThanhToanVM
@{
    ViewData["Title"] = "Thanh Toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var tongTien = Model.GioHang.Sum(p => p.ThanhTien);
    var phiVanChuyen = 30000m; // Phí vận chuyển mặc định
    var tongCong = tongTien + phiVanChuyen;
}

<!-- Single Page Header start -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Thanh Toán</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-controller="GioHang" asp-action="Index">Giỏ hàng</a></li>
        <li class="breadcrumb-item active text-white">Thanh toán</li>
    </ol>
</div>
<!-- Single Page Header End -->
<!-- Checkout Page Start -->
<div class="container-fluid py-5">
    <div class="container py-5">
        <div asp-validation-summary="All" class="text-danger mb-3"></div>
        <form asp-action="ThanhToan" asp-controller="GioHang" method="post">
            <div class="row g-5">
                <!-- THÔNG TIN GIAO HÀNG -->
                <div class="col-md-12 col-lg-6 col-xl-7">

                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">

                            <h4 class="mb-4 border-bottom pb-2">
                                <i class="fa fa-truck me-2 text-primary"></i>
                                Thông tin giao hàng
                            </h4>

                            @if (Model.DiaChiDaLuu?.Any() == true)
                            {
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">Chọn địa chỉ đã lưu</label>
                                    <div class="list-group">
                                        @foreach (var diaChi in Model.DiaChiDaLuu)
                                        {
                                            <label class="list-group-item list-group-item-action d-flex gap-3 align-items-start">
                                                <input class="form-check-input mt-1" type="checkbox" name="savedAddress"
                                                       value="@diaChi.MaDiaChi"
                                                       data-ten="@diaChi.TenNguoiNhan"
                                                       data-phone="@diaChi.DienThoaiNhan"
                                                       data-diachi="@diaChi.DiaChiChiTiet"
                                                       data-phuong="@diaChi.PhuongXa"
                                                       data-quan="@diaChi.QuanHuyen"
                                                       data-tinh="@diaChi.TinhThanh"
                                                       @((diaChi.MacDinh) ? "checked=\"checked\"" : "") />
                                                <div>
                                                    <div class="fw-semibold">@diaChi.TenNguoiNhan</div>
                                                    <div class="text-muted small">@diaChi.DienThoaiNhan</div>
                                                    <div class="small">@diaChi.DiaChiChiTiet, @diaChi.PhuongXa, @diaChi.QuanHuyen, @diaChi.TinhThanh</div>
                                                    @if (diaChi.MacDinh)
                                                    {
                                                        <span class="badge bg-primary-subtle text-primary border border-primary mt-1">Mặc định</span>
                                                    }
                                                </div>
                                            </label>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Họ tên -->
                            <div class="mb-3">
                                <label class="form-label">
                                    Họ tên người nhận <sup class="text-danger">*</sup>
                                </label>
                                <input asp-for="HoTen" class="form-control"
                                       placeholder="Nhập họ tên người nhận hàng" required>
                                <span asp-validation-for="HoTen" class="text-danger"></span>
                            </div>

                            <!-- SĐT -->
                            <div class="mb-3">
                                <label class="form-label">
                                    Số điện thoại <sup class="text-danger">*</sup>
                                </label>
                                <input asp-for="DienThoai" type="tel" class="form-control"
                                       placeholder="Nhập số điện thoại liên hệ"
                                       pattern="[0-9]{10,11}" required>
                                <span asp-validation-for="DienThoai" class="text-danger"></span>
                            </div>

                            <!-- ĐỊA CHỈ HÀNH CHÍNH -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Tỉnh / Thành phố <sup class="text-danger">*</sup>
                                    </label>
                                    <select id="tinh" asp-for="TinhThanh" class="form-select" required>
                                        <option value="">-- Chọn tỉnh/thành phố --</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Quận / Huyện <sup class="text-danger">*</sup>
                                    </label>
                                    <select id="quan" asp-for="QuanHuyen" class="form-select" required disabled>
                                        <option value="">-- Chọn quận/huyện --</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Phường / Xã <sup class="text-danger">*</sup>
                                    </label>
                                    <select id="phuong" asp-for="PhuongXa" class="form-select" required disabled>
                                        <option value="">-- Chọn phường/xã --</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Địa chỉ chi tiết -->
                            <div class="mb-3">
                                <label class="form-label">
                                    Địa chỉ cụ thể <sup class="text-danger">*</sup>
                                </label>
                                <input asp-for="DiaChi" class="form-control"
                                       placeholder="Số nhà, tên đường"
                                       required>
                                <span asp-validation-for="DiaChi" class="text-danger"></span>
                            </div>

                            <!-- Ghi chú -->
                            <div class="mb-0">
                                <label class="form-label">Ghi chú đơn hàng</label>
                                <textarea asp-for="GhiChu" class="form-control" rows="3"
                                          placeholder="Ví dụ: giao giờ hành chính, gọi trước khi giao"></textarea>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- Tóm tắt đơn hàng -->
                <div class="col-md-12 col-lg-6 col-xl-5">
                    <h4 class="mb-4">Đơn hàng của bạn</h4>

                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">Sản phẩm</th>
                                    <th scope="col">Tên</th>
                                    <th scope="col">SL</th>
                                    <th scope="col">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.GioHang)
                                {
                                    <tr>
                                        <td>
                                            <img src="~/customerassets/img/Anh/@item.AnhChinh" class="img-fluid rounded"
                                                 style="width: 60px; height: 60px; object-fit: cover;" alt="@item.TenSp">
                                        </td>
                                        <td class="align-middle">@item.TenSp</td>
                                        <td class="align-middle">@item.SoLuong</td>
                                        <td class="align-middle">@item.ThanhTien.ToString("N0")đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Tổng tiền -->
                    <div class="bg-light rounded p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Tạm tính:</span>
                            <span>@tongTien.ToString("N0")đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Phí vận chuyển:</span>
                            <span>@phiVanChuyen.ToString("N0")đ</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Tổng cộng:</strong>
                            <strong class="text-primary fs-5">@tongCong.ToString("N0")đ</strong>
                        </div>
                    </div>


                    <!-- Nút đặt hàng -->
                    <div>
                        <input type="submit" name="payment" class="btn btn-primary w-100 py-3"
                               value="Đặt hàng (COD)">
                    </div>
                    <div>
                        <input type="submit" name="payment" class="btn btn-primary w-100 py-3 mt-2"
                               value="Thanh toán VNPay">
                    </div>

                    <div class="text-center mt-3">
                        <a asp-controller="GioHang" asp-action="Index" class="text-muted">
                            <i class="fa fa-arrow-left me-2"></i> Quay lại giỏ hàng
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Checkout Page End -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        /* ================= DOM ================= */
        const tinhSelect = document.getElementById("tinh");
        const quanSelect = document.getElementById("quan");
        const phuongSelect = document.getElementById("phuong");

        const hoTenInput = document.querySelector('[name="HoTen"]');
        const phoneInput = document.querySelector('[name="DienThoai"]');
        const diaChiInput = document.querySelector('[name="DiaChi"]');

        const savedAddressCheckboxes = document.querySelectorAll('input[name="savedAddress"]');

        let pendingAddress = null; // 🔑 xử lý async load tỉnh

        /* ================= RESET ================= */
        function resetQuanHuyen() {
            quanSelect.innerHTML = '<option value="">-- Chọn quận/huyện --</option>';
            quanSelect.disabled = true;
        }

        function resetPhuongXa() {
            phuongSelect.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
            phuongSelect.disabled = true;
        }

        function clearAutoFill() {
            hoTenInput.value = "";
            phoneInput.value = "";
            diaChiInput.value = "";
            tinhSelect.value = "";
            resetQuanHuyen();
            resetPhuongXa();
        }

        /* ================= LOAD API ================= */
        function loadQuanHuyen(tinhCode, preQuan, prePhuong) {
            resetQuanHuyen();
            resetPhuongXa();
            if (!tinhCode) return;

            fetch(`https://provinces.open-api.vn/api/p/${tinhCode}?depth=2`)
                .then(res => res.json())
                .then(data => {
                    quanSelect.disabled = false;
                    data.districts.forEach(q => {
                        quanSelect.innerHTML += `
                            <option value="${q.name}" data-code="${q.code}">
                                ${q.name}
                            </option>`;
                    });

                    if (preQuan) {
                        quanSelect.value = preQuan;
                        const code = quanSelect.selectedOptions[0]?.dataset.code;
                        loadPhuong(code, prePhuong);
                    }
                });
        }

        function loadPhuong(quanCode, prePhuong) {
            resetPhuongXa();
            if (!quanCode) return;

            fetch(`https://provinces.open-api.vn/api/d/${quanCode}?depth=2`)
                .then(res => res.json())
                .then(data => {
                    phuongSelect.disabled = false;
                    data.wards.forEach(p => {
                        phuongSelect.innerHTML += `
                            <option value="${p.name}">${p.name}</option>`;
                    });

                    if (prePhuong) {
                        phuongSelect.value = prePhuong;
                    }
                });
        }

        /* ================= APPLY SAVED ADDRESS ================= */
        function tryApplyPendingAddress() {
            if (!pendingAddress) return;
            if (tinhSelect.options.length <= 1) return; // tỉnh chưa load xong

            const { ten, phone, diachi, tinh, quan, phuong } = pendingAddress;

            hoTenInput.value = ten || "";
            phoneInput.value = phone || "";
            diaChiInput.value = diachi || "";

            const matchedTinh = Array.from(tinhSelect.options)
                .find(o => o.value === tinh);

            if (matchedTinh) {
                tinhSelect.value = tinh;
                loadQuanHuyen(matchedTinh.dataset.code, quan, phuong);
                pendingAddress = null;
            }
        }

        /* ================= LOAD TỈNH ================= */
        fetch("https://provinces.open-api.vn/api/p/")
            .then(res => res.json())
            .then(data => {
                data.forEach(tinh => {
                    tinhSelect.innerHTML += `
                        <option value="${tinh.name}" data-code="${tinh.code}">
                            ${tinh.name}
                        </option>`;
                });

                tryApplyPendingAddress(); // 🔑 quan trọng
            });

        /* ================= EVENT ================= */
        savedAddressCheckboxes.forEach(cb => {
            cb.addEventListener("change", function () {

                // chỉ cho chọn 1 địa chỉ
                savedAddressCheckboxes.forEach(x => {
                    if (x !== this) x.checked = false;
                });

                if (this.checked) {
                    pendingAddress = this.dataset;
                    tryApplyPendingAddress();
                } else {
                    pendingAddress = null;
                    clearAutoFill();
                }
            });
        });

        tinhSelect.addEventListener("change", function () {
            const code = this.selectedOptions[0]?.dataset.code;
            loadQuanHuyen(code);
        });

        quanSelect.addEventListener("change", function () {
            const code = this.selectedOptions[0]?.dataset.code;
            loadPhuong(code);
        });

    });
</script>
