@model KIDORA.ViewModels.ChiTietSanPhamVM
@{
    ViewData["Title"] = "ChiTietSanPham";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- spacer to avoid fixed header overlapping content -->
<div style="height:120px;"></div>

<!-- Single Page Header End -->
<!-- Single Product Start -->
<div class="container-fluid py-5 mt-5">
    <div class="container py-5">
        <div class="row g-4 mb-5">
            <div class="col-lg-8 col-xl-9">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="border rounded">

                            <!-- ẢNH LỚN -->
                            <img id="mainImage"
                                 src="/customerassets/img/Anh/@Model.AnhSanPhams.FirstOrDefault()"
                                 class="img-fluid rounded mb-3"
                                 alt="@Model.TenSp" />

                            <!-- ẢNH NHỎ -->
                            <div class="d-flex gap-2 flex-wrap justify-content-center">
                                @foreach (var img in Model.AnhSanPhams)
                                {
                                    <img src="~/customerassets/img/Anh/@img"
                                         class="border rounded"
                                         style="width:70px; height:70px; object-fit:cover; cursor:pointer"
                                         onclick="changeImage('@img')" />
                                }
                            </div>

                        </div>

                    </div>
                    <div class="col-lg-6">
                        <h4 class="fw-bold mb-3">@Model.TenSp</h4>
                        <p class="mb-3">Danh mục: @Model.TenDanhMuc</p>
                        <p class="mb-3">Số lượng tồn: @Model.SoLuongTon</p>
                        @{
                            // Filter out placeholder/invalid variants so selector only shows for real variants
                            var variants = Model.BienThes?.Where(bt => !string.IsNullOrWhiteSpace(bt.MaBienThe) &&
                                                                     !string.IsNullOrWhiteSpace(bt.TenBienThe) &&
                                                                     bt.TenBienThe.Trim().ToLower() != "chọn biến thể").ToList()
                                           ?? new List<KIDORA.ViewModels.BienTheVM>();

                            var displayPrice = Model.DonGiaBan;
                            var singleVariant = variants.Count == 1 ? variants[0] : null;
                            if (singleVariant != null) displayPrice = singleVariant.GiaBan;
                        }

                        <h5 class="fw-bold mb-3 text-danger" id="giaHienThi">
                            @displayPrice.ToString("N0") đ
                        </h5>

                        @* Only show selector when there are more than 1 real variants *@
                        @if (variants.Count > 1)
                        {
                            <label class="fw-bold">Chọn biến thể</label>
                            <select class="form-select mb-3" id="variantSelect" name="variantId">
                                @foreach (var bt in variants)
                                {
                                    <option value="@bt.MaBienThe"
                                            data-gia="@bt.GiaBan"
                                            data-ton="@bt.SoLuongTon"
                                            data-anh="@bt.AnhBienThe.FirstOrDefault()">
                                        @bt.TenBienThe
                                    </option>
                                }
                            </select>
                        }
                        else if (singleVariant != null)
                        {
                            // include hidden variant id so AddToCart can pick it up if needed
                            <input type="hidden" name="variantId" value="@singleVariant.MaBienThe" />
                        }

                        <div class="d-flex mb-4">
                            <i class="fa fa-star text-secondary"></i>
                            <i class="fa fa-star text-secondary"></i>
                            <i class="fa fa-star text-secondary"></i>
                            <i class="fa fa-star text-secondary"></i>
                            <i class="fa fa-star"></i>
                        </div>
                        <p class="mb-4">@Model.MoTaNgan</p>
                        <form asp-action="AddToCart"
                              asp-controller="GioHang"
                              asp-route-id="@Model.MaSp">
                            <div class="input-group quantity mb-5" style="width: 100px;">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-minus rounded-circle bg-light border" type="button">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm text-center border-0" value="1" name="quantiy">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-plus rounded-circle bg-light border" type="button">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="btn border border-secondary rounded-pill px-4 py-2 mb-4 text-primary"><i class="fa fa-shopping-bag me-2 text-primary"></i>Thêm vào giỏ</button>
                        </form>
                    </div>
                    <div class="col-lg-12">
                        <nav>
                            <div class="nav nav-tabs mb-3">
                                <button class="nav-link active border-white border-bottom-0" type="button" role="tab"
                                        id="nav-about-tab" data-bs-toggle="tab" data-bs-target="#nav-about"
                                        aria-controls="nav-about" aria-selected="true">
                                    Thông tin hàng hóa
                                </button>
                                <button class="nav-link border-white border-bottom-0" type="button" role="tab"
                                        id="nav-mission-tab" data-bs-toggle="tab" data-bs-target="#nav-mission"
                                        aria-controls="nav-mission" aria-selected="false">
                                    Đánh giá
                                </button>
                            </div>
                        </nav>
                        <div class="tab-content mb-5">
                            <div class="tab-pane active" id="nav-about" role="tabpanel" aria-labelledby="nav-about-tab">
                                @Model.MoTaChiTiet

                            </div>
                            <div class="tab-pane" id="nav-mission" role="tabpanel" aria-labelledby="nav-mission-tab">

                                @if (Model.DanhGias != null && Model.DanhGias.Any())
                                {
                                    foreach (var dg in Model.DanhGias)
                                    {
                                        <div class="d-flex mb-4">
                                            <!-- Avatar -->
                                            <img src="~/adminassets/images/avatar/2.png"
                                                 class="img-fluid rounded-circle p-3"
                                                 style="width:100px;height:100px;"
                                                 alt="avatar" />


                                            <div>
                                                <!-- Ngày đánh giá -->
                                                <p class="mb-2" style="font-size:14px;">
                                                    @dg.NgayDanhGia.ToString("dd/MM/yyyy")
                                                </p>

                                                <!-- Tên + sao -->
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">
                                                        @dg.HoTen
                                                    </h5>

                                                    <div class="d-flex mb-3">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            if (i <= dg.DiemDanhGia)
                                                            {
                                                                <i class="fa fa-star text-warning"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="fa fa-star text-secondary"></i>
                                                            }
                                                        }
                                                    </div>
                                                </div>

                                                <!-- Nội dung -->
                                                <p class="text-dark">
                                                    @dg.NoiDung
                                                </p>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
                                }

                            </div>

                            <form asp-action="ThemDanhGia"
                                  asp-controller="SanPham"
                                  method="post">

                                <!-- MA SP (ẨN) -->
                                <input type="hidden" name="MaSp" value="@Model.MaSp" />

                                <h4 class="mb-5 fw-bold">Để lại đánh giá của bạn</h4>

                                <div class="row g-4">
                                    <div class="col-lg-6">
                                        <input type="text"
                                               name="TenKhachHang"
                                               class="form-control"
                                               placeholder="Tên của bạn *"
                                               required />
                                    </div>

                                    <div class="col-lg-12">
                                        <textarea name="NoiDung"
                                                  class="form-control"
                                                  rows="5"
                                                  placeholder="Đánh giá của bạn *"
                                                  required></textarea>
                                    </div>

                                    <!-- SỐ SAO -->
                                    <div class="col-lg-12">
                                        <label>Số sao:</label>
                                        <select name="DiemDanhGia" class="form-select w-auto">
                                            <option value="5">★★★★★</option>
                                            <option value="4">★★★★</option>
                                            <option value="3">★★★</option>
                                            <option value="2">★★</option>
                                            <option value="1">★</option>
                                        </select>
                                    </div>

                                    <div class="col-lg-12">
                                        <button type="submit"
                                                class="btn border border-secondary text-primary rounded-pill px-4 py-2">
                                            Gửi đánh giá
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-4 col-xl-3">
                        <div class="row g-4 fruite">
                            <div class="col-lg-12">
                                <div class="mb-4">
                                    @await Component.InvokeAsync("MenuDanhMuc")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <h1 class="fw-bold mb-4">Sản phẩm liên quan</h1>

                @if (ViewBag.RelatedProducts != null)
                {
                    var relatedProducts = ViewBag.RelatedProducts as List<KIDORA.ViewModels.ListSanPhamVM>;

                    <div class="vesitable">
                        <div class="owl-carousel vegetable-carousel justify-content-center">

                            @foreach (var item in relatedProducts)
                            {
                                <div class="border border-primary rounded position-relative vesitable-item">

                                    <!-- LINK ĐI CHI TIẾT SẢN PHẨM -->
                                    <a asp-controller="SanPham"
                                       asp-action="ChiTietSanPham"
                                       asp-route-id="@item.MaSp"
                                       class="text-decoration-none text-dark d-block product-link">

                                        <div class="vesitable-img">
                                            <img src="~/customerassets/img/Anh/@item.AnhChinh"
                                                 class="img-fluid w-100 rounded-top"
                                                 alt="@item.TenSp"
                                                 style="height:200px; object-fit:cover;">
                                        </div>

                                        <div class="p-4 pb-2 rounded-bottom">
                                            <h5 class="mb-2">@item.TenSp</h5>
                                            <p class="text-muted small mb-2">
                                                @item.MoTaNgan
                                            </p>

                                            <p class="text-danger fs-5 fw-bold mb-3">
                                                @item.DonGiaBan.ToString("N0") VND
                                            </p>
                                        </div>
                                    </a>

                                    <!-- NÚT ADD TO CART (KHÔNG BỌC TRONG LINK TRÊN) -->
                                    <div class="px-4 pb-4">
                                        <a asp-controller="GioHang"
                                           asp-action="AddToCart"
                                           asp-route-id="@item.MaSp"
                                           class="btn border border-secondary rounded-pill px-3 py-1 text-primary w-100">
                                            <i class="fa fa-shopping-bag me-2 text-primary"></i>
                                            Thêm vào giỏ
                                        </a>
                                    </div>

                                </div>
                            }

                        </div>
                    </div>
                }
            </div>
        </div>
        <!-- Single Product End -->
        <script>
            function changeImage(img) {
                document.getElementById("mainImage").src = '/customerassets/img/Anh/' + img;
            }
        </script>
        <script>
            document.getElementById("variantSelect")?.addEventListener("change", function () {
                const opt = this.selectedOptions[0];
                if (!opt) return;

                const gia = Number(opt.dataset.gia);
                if (isNaN(gia)) return;

                document.getElementById("giaHienThi").innerText =
                    gia.toLocaleString('vi-VN') + ' đ';

                if (opt.dataset.anh) {
                    document.getElementById("mainImage").src = '/customerassets/img/Anh/' + opt.dataset.anh;
                }
            });
        </script>

